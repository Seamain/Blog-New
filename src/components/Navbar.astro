---
import Icon from "astro-icon";
import { getNavigationRender } from "../api/Navigation";
import type { Navigation } from "../interfaces/Navigation";

let navigations: Navigation[] = [];
try {
  navigations = (await getNavigationRender("main-navigation")) as Navigation[];
} catch (error) {
  console.error("Failed to load navigation:", error instanceof Error ? error.message : String(error));
  navigations = []; // Fallback to empty navigation
}
---

<nav
  class="sticky top-0 z-40 w-full border-b border-slate-200/80 bg-white/80 backdrop-blur dark:bg-slate-900/80 dark:border-slate-700/80"
>
  <div
    class="relative flex w-full flex-row gap-4 px-6 py-4 not-sm:flex-row not-sm:items-center justify-around"
  >
    <a
      href="/"
      class="flex items-center gap-3 text-2xl font-semibold tracking-tight"
    >
      <Icon
        class="rounded-full border border-slate-200 p-1 dark:border-slate-700"
        name="Icon"
        width="36px"
      />
      <span class="text-slate-800 dark:text-slate-100">Seamain</span>
    </a>

    <!-- Mobile controls -->
    <div
      class="flex items-center gap-2 md:hidden lg:hidden xl:hidden 2xl:hidden"
    >
      <!-- Mobile menu button -->
      <button
        id="mobile-menu-button"
        class="flex items-center justify-center p-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-300 dark:hover:text-slate-100 dark:hover:bg-slate-800"
        aria-label="Toggle mobile menu"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>

      <!-- Mobile theme toggle button -->
      <button
        id="mobile-theme-toggle"
        class="flex items-center justify-center p-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-300 dark:hover:text-slate-100 dark:hover:bg-slate-800"
        aria-label="Toggle theme"
      >
        <svg
          id="mobile-theme-toggle-light-icon"
          class="w-5 h-5 hidden"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
            fill-rule="evenodd"
            clip-rule="evenodd"></path>
        </svg>
        <svg
          id="mobile-theme-toggle-dark-icon"
          class="w-5 h-5 hidden"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Desktop navigation -->
    <div
      class="not-sm:hidden not-md:hidden flex items-center justify-end gap-3"
    >
      {
        navigations.map((item) => (
          <a
            href={"/" + item.path}
            class="rounded-full px-4 py-2 text-sm font-medium text-slate-600 transition hover:bg-slate-900/5 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-slate-100/5 dark:hover:text-slate-100"
          >
            {item.title}
          </a>
        ))
      }

      <!-- Theme toggle button -->
      <button
        id="theme-toggle"
        class="flex items-center justify-center p-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-300 dark:hover:text-slate-100 dark:hover:bg-slate-800"
        aria-label="Toggle theme"
      >
        <svg
          id="theme-toggle-light-icon"
          class="w-5 h-5 hidden"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
            fill-rule="evenodd"
            clip-rule="evenodd"></path>
        </svg>
        <svg
          id="theme-toggle-dark-icon"
          class="w-5 h-5 hidden"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Mobile navigation (hidden by default) -->
    <div
      id="mobile-menu"
      class="hidden absolute top-full left-0 right-0 bg-white border-b border-slate-200 shadow-lg dark:bg-slate-900 dark:border-slate-700"
    >
      <div class="px-6 py-4 space-y-2">
        {
          navigations.map((item) => (
            <a
              href={"/" + item.path}
              class="block rounded-lg px-4 py-3 text-base font-medium text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100"
            >
              {item.title}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</nav>

<script>
  // Check for saved theme preference or default to system preference
  function getThemePreference(): string {
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
      return savedTheme;
    }
    return window.matchMedia("(prefers-color-scheme: dark)").matches
      ? "dark"
      : "light";
  }

  // Apply theme
  function applyTheme(theme: string) {
    const lightIcon = document.getElementById("theme-toggle-light-icon");
    const darkIcon = document.getElementById("theme-toggle-dark-icon");
    const mobileLightIcon = document.getElementById(
      "mobile-theme-toggle-light-icon",
    );
    const mobileDarkIcon = document.getElementById(
      "mobile-theme-toggle-dark-icon",
    );

    if (theme === "dark") {
      document.documentElement.classList.add("dark");
      lightIcon?.classList.remove("hidden");
      darkIcon?.classList.add("hidden");
      mobileLightIcon?.classList.remove("hidden");
      mobileDarkIcon?.classList.add("hidden");
    } else {
      document.documentElement.classList.remove("dark");
      lightIcon?.classList.add("hidden");
      darkIcon?.classList.remove("hidden");
      mobileLightIcon?.classList.add("hidden");
      mobileDarkIcon?.classList.remove("hidden");
    }
  }

  // Initialize theme immediately to prevent flash
  const currentTheme = getThemePreference();
  applyTheme(currentTheme);

  // DOM ready event handler
  document.addEventListener("DOMContentLoaded", function () {
    // Theme toggle functionality for desktop
    const themeToggle = document.getElementById("theme-toggle");
    const lightIcon = document.getElementById("theme-toggle-light-icon");
    const darkIcon = document.getElementById("theme-toggle-dark-icon");

    // Theme toggle functionality for mobile
    const mobileThemeToggle = document.getElementById("mobile-theme-toggle");
    const mobileLightIcon = document.getElementById(
      "mobile-theme-toggle-light-icon",
    );
    const mobileDarkIcon = document.getElementById(
      "mobile-theme-toggle-dark-icon",
    );

    console.log("Theme toggle button:", themeToggle);
    console.log("Light icon:", lightIcon);
    console.log("Dark icon:", darkIcon);

    // Reapply theme to ensure icons are correct
    applyTheme(getThemePreference());

    // Toggle theme handler
    function toggleTheme() {
      console.log("Theme toggle clicked!");
      const isDark = document.documentElement.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      console.log("Switching to:", newTheme);
      localStorage.setItem("theme", newTheme);
      applyTheme(newTheme);
    }

    if (themeToggle) {
      themeToggle.addEventListener("click", toggleTheme);
    }

    if (mobileThemeToggle) {
      mobileThemeToggle.addEventListener("click", toggleTheme);
    }

    // Listen for system theme changes
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        // Only auto-update if user hasn't set a preference
        if (!localStorage.getItem("theme")) {
          applyTheme(e.matches ? "dark" : "light");
        }
      });

    // Mobile menu functionality
    const mobileMenuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");

    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener("click", function () {
        mobileMenu.classList.toggle("hidden");
      });

      // Close menu when clicking outside
      document.addEventListener("click", function (event) {
        const target = event.target as Node;
        if (
          !mobileMenuButton.contains(target) &&
          !mobileMenu.contains(target)
        ) {
          mobileMenu.classList.add("hidden");
        }
      });
    }
  });
</script>
