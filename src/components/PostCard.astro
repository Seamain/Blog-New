---
import { encode } from "node-base64-image";
import formatDate from "../libs/formatDate";
import { Icon } from "astro-icon/components";
import type Post from "../interfaces/Post";

interface Props {
  post: Post;
  ml?: string;
}

const { post, ml } = Astro.props;
const avatarUrl = post.author?.avatar?.formats?.thumbnail?.url;
let avatar: string | null = null;
try {
    avatar = avatarUrl ? (await encode(avatarUrl, { string: true })) as string : null;
} catch (error) {
    console.error("Failed to encode avatar in PostCard:", error instanceof Error ? error.message : String(error));
    avatar = null;
}
const formatedTime = formatDate(new Date(post.createdAt), "yyyy-MM-dd");
---

<article
  class="group relative mt-10 overflow-hidden rounded-3xl border border-slate-100/60 bg-white/90 shadow-lg shadow-slate-200/60 transition-all duration-300 hover:-translate-y-1 hover:border-slate-200 hover:shadow-xl dark:border-slate-800/60 dark:bg-slate-900/90 dark:shadow-slate-950/60 dark:hover:border-slate-700 max-w-2xl w-full"
>
  <div class="absolute inset-x-4 top-4 h-24 rounded-3xl bg-linear-to-r from-indigo-50 to-blue-50 opacity-0 blur-2xl transition group-hover:opacity-70 dark:from-indigo-950 dark:to-blue-950" aria-hidden="true"></div>
  <a href=`/posts/${post.slug}` class="relative flex flex-col gap-6 px-6 py-6">
    <header class="flex flex-wrap items-center gap-4 text-sm text-slate-500 dark:text-slate-400">
      <div class="flex items-center gap-3">
        {avatar ? (
          <img
            src={`data:image/png;base64,${avatar}`}
            class="h-10 w-10 rounded-full border border-slate-200 object-cover dark:border-slate-700"
            loading="lazy"
            alt={`这是作者${post.author?.name}的头像`}
          />
        ) : (
          <div class="flex h-10 w-10 items-center justify-center rounded-full border border-dashed border-slate-200 text-xs uppercase text-slate-400 dark:border-slate-700 dark:text-slate-500">
            {post.author?.name?.slice(0, 1) ?? "?"}
          </div>
        )}
        <div>
          <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">{post.author?.name}</p>
          <div class="flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500">
            <Icon class="h-4 w-4" name="Clock" />
            <span>{formatedTime}</span>
          </div>
        </div>
      </div>
      <div class="ml-auto flex flex-wrap items-center gap-2">
        {
          post.tags.slice(0, 3).map((tag) => (
            <span class="rounded-full border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 dark:border-slate-700 dark:text-slate-400">
              {tag.name}
            </span>
          ))
        }
      </div>
    </header>

    <div>
      <h3 class="text-2xl font-semibold tracking-tight text-slate-900 transition group-hover:text-slate-700 dark:text-slate-100 dark:group-hover:text-slate-300">
        {post.title}
      </h3>
      <p class="mt-3 line-clamp-3 text-base text-slate-600 dark:text-slate-400">
        {post.summary}
      </p>
    </div>

    <footer class="flex items-center gap-2 text-sm font-medium text-indigo-600 dark:text-indigo-400">
      <span>阅读文章</span>
      <svg
        class="h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
      </svg>
    </footer>
  </a>
</article>
