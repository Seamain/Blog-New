---
import type { GetStaticPaths } from "astro";
import { createFullListOfCategory } from "../../../api/Category";
import { createFullListOfPost } from "../../../api/Post";
import Navbar from "../../../components/Navbar.astro";
import Pagination from "../../../components/Pagination.astro";
import PostCard from "../../../components/PostCard.astro";
import type Page from "../../../interfaces/Page";
import type Post from "../../../interfaces/Post";
import BasicStyle from "../../../layouts/BasicStyle.astro";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  try {
    const fullListOfCategories = await createFullListOfCategory("zh-Hans");
    const fullListOfPosts = await createFullListOfPost("zh-Hans");

    return fullListOfCategories.flatMap((category) => {
      const filteredPosts = fullListOfPosts.filter(
        (post) => post.category?.slug === category.slug,
      );

      return paginate(filteredPosts, {
        params: { slug: category.slug },
        pageSize: 5,
      });
    });
  } catch (error) {
    console.error("Failed to generate categories pagination:", error instanceof Error ? error.message : String(error));
    return paginate([], {
      params: { slug: "fallback" },
      pageSize: 5,
    }); // Return empty pagination as fallback
  }
};

const { page } = Astro.props as { page: Page<Post> };
const params = Astro.params;
const totalPage = page.lastPage;
---

<BasicStyle title={`${params.slug} Category`} description={`This is my ${params.slug} page.`}>
  <div class="relative w-full">
    <Navbar />
    <main class="mx-auto w-full max-w-6xl px-6 pb-20">
      <section class="mt-10 rounded-3xl border border-slate-200/70 bg-white/80 px-8 py-10 shadow-sm dark:border-slate-800/70 dark:bg-slate-900/70">
        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-blue-700/80 dark:text-blue-300/80">
          Category
        </p>
        <h1 class="mt-4 text-4xl font-display tracking-tight text-slate-900 dark:text-slate-50 md:text-5xl">
          {params.slug}
        </h1>
        <p class="mt-4 max-w-2xl text-base text-slate-600 dark:text-slate-400">
          查看该分类下的全部文章更新。
        </p>
      </section>

      {page.data.length ? (
        <>
          <div class="mt-8">
            <PostCard ml="max-h-72" post={page.data[0]} />
          </div>
          <div class="mt-6 grid gap-6 md:grid-cols-2">
            {page.data.slice(1, 5).map((post) => (
              <PostCard ml="max-h-52" post={post} />
            ))}
          </div>
          <div class="mt-12 flex justify-center">
            <Pagination
              currentPage={page.currentPage}
              {totalPage}
              url={`categories/${params.slug}`}
            />
          </div>
        </>
      ) : (
        <div class="mt-8 rounded-2xl border border-dashed border-slate-300/80 bg-white/60 px-6 py-10 text-center text-sm text-slate-500 dark:border-slate-700/80 dark:bg-slate-900/50 dark:text-slate-400">
          这里暂时还没有内容，请等我以后更新哦~
        </div>
      )}
    </main>
  </div>
</BasicStyle>
